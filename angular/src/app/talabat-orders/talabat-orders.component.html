<div class="orders-page">
  <p-toast></p-toast>
  <div class="page-header">
    <div>
      <h2 class="page-title">Talabat Orders</h2>
      <p class="page-subtitle">Incoming webhook orders and their sync status</p>
    </div>
    <button pButton type="button" icon="pi pi-refresh" label="Refresh" class="p-button-outlined" (click)="refresh()"></button>
  </div>

  <div class="filters">
    <span class="filter-item">
      <label for="vendorCode">Vendor Code</label>
      <input
        id="vendorCode"
        type="text"
        pInputText
        [ngModel]="vendorCode()"
        (ngModelChange)="vendorCode.set($event)"
        placeholder="PH-SIDDIQ-002"
      />
    </span>
    <span class="filter-item">
      <label for="status">Status</label>
      <select
        id="status"
        class="status-select"
        [ngModel]="status()"
        (ngModelChange)="status.set($event || '')"
      >
        <option *ngFor="let option of statusOptions" [value]="option.value">
          {{ option.label }}
        </option>
      </select>
    </span>
  </div>

  <p-table
    [value]="logs()"
    [lazy]="true"
    [paginator]="true"
    [rows]="rows()"
    [totalRecords]="totalRecords()"
    [first]="first()"
    [loading]="loading()"
    (onLazyLoad)="loadLogs($event)"
    [rowsPerPageOptions]="[10, 20, 50]"
    sortField="receivedAt"
    [sortOrder]="-1"
    dataKey="id"
  >
    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="receivedAt">Received <p-sortIcon field="receivedAt"></p-sortIcon></th>
        <th pSortableColumn="vendorCode">Vendor <p-sortIcon field="vendorCode"></p-sortIcon></th>
        <th>Order</th>
        <th pSortableColumn="orderToken">Token <p-sortIcon field="orderToken"></p-sortIcon></th>
        <th pSortableColumn="productsCount">Products <p-sortIcon field="productsCount"></p-sortIcon></th>
        <th pSortableColumn="categoriesCount">Categories <p-sortIcon field="categoriesCount"></p-sortIcon></th>
        <th>Status</th>
        <th pSortableColumn="attempts">Attempts <p-sortIcon field="attempts"></p-sortIcon></th>
        <th>Last Error</th>
        <th>Actions</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-row>
      <tr>
        <td>
          <div class="date-cell">{{ row.receivedAt || row.creationTime | date: 'short' }}</div>
        </td>
        <td>{{ row.vendorCode || '-' }}</td>
        <td>
          <div class="order-cell">
            <div class="order-code">{{ getOrderCode(row) }}</div>
            <p-tag *ngIf="row.isTestOrder" value="TEST" severity="warn"></p-tag>
          </div>
        </td>
        <td class="token-cell" [title]="row.orderToken || ''">{{ row.orderToken || '-' }}</td>
        <td>{{ row.productsCount ?? 0 }}</td>
        <td>{{ row.categoriesCount ?? 0 }}</td>
        <td>
          <p-tag [severity]="getStatusSeverity(row.status)" [value]="row.status || 'Unknown'"></p-tag>
        </td>
        <td>{{ row.attempts ?? 0 }}</td>
        <td class="error-cell">
          <ng-container *ngIf="row.lastError; else noError">
            <button
              pButton
              type="button"
              icon="pi pi-exclamation-circle"
              label="View"
              class="p-button-text p-button-sm"
              (click)="openErrorDialog(row)"
            ></button>
          </ng-container>
          <ng-template #noError>-</ng-template>
        </td>
        <td>
          <button
            pButton
            type="button"
            icon="pi pi-refresh"
            label="Retry"
            class="p-button-outlined p-button-sm"
            [disabled]="(row.status || '').toLowerCase() !== 'failed'"
            (click)="retryOrder(row)"
          ></button>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="10">No orders recorded yet.</td>
      </tr>
    </ng-template>
  </p-table>

  <p-dialog
    header="Last Error"
    [modal]="true"
    [style]="{ width: '40rem', maxWidth: '90vw' }"
    [visible]="errorDialogVisible()"
    (visibleChange)="errorDialogVisible.set($event)"
  >
    <pre style="white-space: pre-wrap; margin: 0;">{{ selectedErrorMessage() }}</pre>
  </p-dialog>
</div>
